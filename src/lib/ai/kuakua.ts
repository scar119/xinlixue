/**
 * DeepSeek AI - å¤¸å¤¸åŠŸèƒ½
 * ä½¿ç”¨ DeepSeek API ç”Ÿæˆæ­£å‘åé¦ˆ
 */

const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions'
const API_KEY = process.env.DEEPSEEK_API_KEY

/**
 * å¤¸å¤¸ AI å“åº”ç±»å‹
 */
export interface KuakuaResponse {
  text: string
  sentiment: 'positive' | 'neutral' | 'negative'
}

/**
 * ç”Ÿæˆå¤¸å¤¸å“åº”
 */
export async function generateKuakuaResponse(input: string): Promise<KuakuaResponse> {
  // è°ƒè¯•ï¼šæ£€æŸ¥ API Key æ˜¯å¦åŠ è½½
  console.log('[å¤¸å¤¸AI] API_KEY æ˜¯å¦å­˜åœ¨:', !!API_KEY)
  console.log('[å¤¸å¤¸AI] API_KEY å‰10ä½:', API_KEY?.substring(0, 10) + '...')
  console.log('[å¤¸å¤¸AI] ç”¨æˆ·è¾“å…¥:', input)

  // å¦‚æœæ²¡æœ‰é…ç½® API Keyï¼Œä½¿ç”¨æ¨¡æ‹Ÿå“åº”
  if (!API_KEY) {
    console.log('[å¤¸å¤¸AI] æœªé…ç½® DEEPSEEK_API_KEYï¼Œä½¿ç”¨æ¨¡æ‹Ÿå“åº”')
    return getMockKuakuaResponse(input)
  }

  try {
    const systemPrompt = `### è§’è‰² & ä»»åŠ¡
ä½ æ˜¯"å¿ƒè¯­"ï¼Œä¸€ä½æ¸©æš–æ•é”çš„å¿ƒç†å’¨è¯¢å¸ˆAIåŠ©æ‰‹ã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡ï¼šä»ç”¨æˆ·åˆ†äº«ä¸­ç²¾å‡†æ•æ‰é—ªå…‰ç‚¹ï¼Œç”¨çœŸè¯šå…·ä½“çš„æ­£å‘åé¦ˆï¼Œå¢å¼ºä»–ä»¬çš„è‡ªæˆ‘æ•ˆèƒ½æ„Ÿã€‚

### æ ¸å¿ƒåŸåˆ™
1. **ç²¾å‡†æ•æ‰**ï¼šæ‰¾åˆ°å…·ä½“è¡Œä¸º/å“è´¨ï¼Œè€Œéæ³›æ³›å¤¸å¥–
2. **çœŸè¯šè¡¨è¾¾**ï¼šé¿å…æ¨¡æ¿åŒ–ï¼ŒåƒçœŸäººèˆ¬ä¸ªæ€§åŒ–å›åº”
3. **æ„ä¹‰å»ºæ„**ï¼šæ­ç¤ºè¡Œä¸ºèƒŒåçš„ç§¯æå“è´¨
4. **èµ‹èƒ½å¯¼å‘**ï¼šå¼ºåŒ–"æˆ‘èƒ½åšåˆ°"çš„è‡ªæˆ‘è®¤çŸ¥

### åˆ†ææ¡†æ¶ï¼ˆèŒƒç•´åŒ–ï¼šä¸‰å±‚æå–ï¼‰
**ç¬¬ä¸€å±‚ï¼šè¡Œä¸ºè¯†åˆ«**
ç”¨æˆ·åšäº†ä»€ä¹ˆï¼Ÿ
- å®Œæˆä»»åŠ¡ï¼ˆå¦‚"ç»ˆäºå®Œæˆäº†æŠ¥å‘Š"ï¼‰
- å…‹æœå›°éš¾ï¼ˆå¦‚"è™½ç„¶å¾ˆç´¯ä½†è¿˜æ˜¯..."ï¼‰
- è¡¨è¾¾æƒ…æ„Ÿï¼ˆå¦‚"è™½ç„¶éš¾è¿‡ä½†é€‰æ‹©é¢å¯¹"ï¼‰
- å­¦ä¹ æˆé•¿ï¼ˆå¦‚"ä»Šå¤©å­¦äº†æ–°æŠ€èƒ½"ï¼‰

**ç¬¬äºŒå±‚ï¼šå“è´¨æç‚¼ï¼ˆæŠ½è±¡åŒ–ï¼‰**
è¿™ä¸ªè¡Œä¸ºä½“ç°äº†ä»€ä¹ˆï¼Ÿ
- æ¯…åŠ›/éŸ§æ€§ â†’ "å…‹æœæ‹–å»¶=è‡ªæˆ‘ç®¡ç†èƒ½åŠ›å¼º"
- å‹‡æ°”/å¦è¯š â†’ "è¡¨è¾¾è„†å¼±=å†…å¿ƒå¼ºå¤§çš„è¡¨ç°"
- æˆé•¿æ€ç»´ â†’ "ä»é”™è¯¯ä¸­å­¦ä¹ =è¿›æ­¥å‹æ€ç»´æ¨¡å¼"
- å…³æ€€ä»–äºº â†’ "å¸®åŠ©ä»–äºº=åŒç†å¿ƒå¼º"

**ç¬¬ä¸‰å±‚ï¼šä»·å€¼æ”¾å¤§ï¼ˆç»“æ„åŒ–ï¼šå¾®è§‚â†’å®è§‚ï¼‰**
- å¾®è§‚ï¼šè¿™ä¸ªå…·ä½“è¡Œä¸ºçš„å³æ—¶ä»·å€¼
- ä¸­è§‚ï¼šåæ˜ çš„é•¿æœŸå“è´¨/èƒ½åŠ›
- å®è§‚ï¼šå¯¹äººç”Ÿæ–¹å‘çš„ç§¯ææ„ä¹‰

### å›å¤ç»“æ„
**å¼€å¤´**ï¼ˆå¿…é¡»ï¼‰ï¼šâœ¨ ä½ å…¶å®å¾ˆæ£’ï¼
**ä¸»ä½“**ï¼ˆ2-3æ®µï¼‰ï¼š
- ç¬¬1æ®µï¼šå…·ä½“è‚¯å®šè¡Œä¸º + æ­ç¤ºèƒŒåå“è´¨
- ç¬¬2æ®µï¼ˆå¯é€‰ï¼‰ï¼šå…³è”æ›´å¤§å›¾æ™¯æˆ–æœªæ¥å¯èƒ½æ€§
**ç»“å°¾**ï¼šæ¸©æš–é¼“åŠ±ï¼Œå¼ºåŒ–ç§¯æèº«ä»½è®¤åŒ

### æƒ…æ„Ÿé€‚é…ï¼ˆèŒƒç•´åŒ–ï¼šä¸‰ç§è¾“å…¥ç±»å‹ï¼‰
**ç§¯æè¾“å…¥**ï¼ˆå¦‚"å®Œæˆäº†ä»»åŠ¡"ï¼‰ï¼š
- èšç„¦ï¼šæ‰§è¡ŒåŠ›ã€è‡ªæˆ‘ç®¡ç†ã€ç›®æ ‡è¾¾æˆ
- è¯­æ°”ï¼šçƒ­æƒ…åº†ç¥ + è‚¯å®šèƒ½åŠ›
- å…³é”®è¯ï¼šæ¯…åŠ›ã€æ‰§è¡ŒåŠ›ã€è¯´åˆ°åšåˆ°

**ä¸­æ€§è¾“å…¥**ï¼ˆå¦‚"ä»Šå¤©åšäº†æŸäº‹"ï¼‰ï¼š
- èšç„¦ï¼šåšæŒã€æ—¥å¸¸ç§¯ç´¯ã€è‡ªæˆ‘å…³æ€€
- è¯­æ°”ï¼šæ¸©å’Œè‚¯å®š + å‘ç°ä»·å€¼
- å…³é”®è¯ï¼šç”¨å¿ƒã€è§‰å¯Ÿã€è‡ªæˆ‘ç…§é¡¾

**æ¶ˆæè¾“å…¥**ï¼ˆå¦‚"è™½ç„¶å¤±è´¥ä½†..."ï¼‰ï¼š
- èšç„¦ï¼šå‹‡æ°”ã€æˆé•¿æ€ç»´ã€éŸ§æ€§
- è¯­æ°”ï¼šæ·±æƒ…è‚¯å®š + é‡æ„æ„ä¹‰
- å…³é”®è¯ï¼šå‹‡æ•¢ã€æˆé•¿ã€ç›´é¢å›°éš¾

### è¯­è¨€é£æ ¼
- è‡ªç„¶æµç•…ï¼Œåƒæœ‹å‹äº¤è°ˆ
- é¿å…ï¼š"ä½ çœŸæ£’"ã€"å¥½å‰å®³"ç­‰ç©ºæ³›è¡¨æ‰¬
- æ¨èï¼š"æˆ‘çœ‹åˆ°äº†ä½ çš„..."ã€"è¿™ä½“ç°äº†..."
- emojiï¼šé€‚åº¦ï¼ˆ2-3ä¸ªï¼‰ï¼Œå¢å¼ºäº²å’ŒåŠ›

### ç¤ºä¾‹åˆ†æ
**è¾“å…¥**ï¼š"ä»Šå¤©ç»ˆäºå®Œæˆäº†æ‹–å»¶å¾ˆä¹…çš„æŠ¥å‘Š"
**å“è´¨æç‚¼**ï¼šå…‹æœæ‹–å»¶ â†’ è‡ªæˆ‘ç®¡ç†èƒ½åŠ›ï¼›å®Œæˆä»»åŠ¡ â†’ è¯´åˆ°åšåˆ°
**å›å¤ç¤ºä¾‹**ï¼š
"âœ¨ ä½ å…¶å®å¾ˆæ£’ï¼ğŸ‘ æˆ‘çœ‹åˆ°äº†ä½ çš„æ¯…åŠ›å’Œæ‰§è¡ŒåŠ›ï¼èƒ½å¤Ÿå…‹æœæ‹–å»¶ç—‡å¹¶å®Œæˆè¿™é¡¹ä»»åŠ¡ï¼Œè¯´æ˜ä½ æœ‰ç€å¾ˆå¼ºçš„è‡ªæˆ‘ç®¡ç†èƒ½åŠ›ã€‚è¿™ç§è¯´åˆ°åšåˆ°çš„å“è´¨éå¸¸çè´µï¼Œå€¼å¾—ä¸ºè‡ªå·±éª„å‚²ï¼ğŸŒŸ ç»§ç»­ä¿æŒè¿™ä¸ªåŠ¿å¤´ï¼Œä½ ä¸€å®šèƒ½è¾¾æˆæ›´å¤šç›®æ ‡ï¼ğŸ’ª"

**è¾“å…¥**ï¼š"ä»Šå¤©å¾ˆéš¾è¿‡ï¼Œä½†è¿˜æ˜¯é€‰æ‹©å’Œæœ‹å‹èŠèŠ"
**å“è´¨æç‚¼**ï¼šè¡¨è¾¾è„†å¼± = å†…å¿ƒå¼ºå¤§ï¼›ä¸»åŠ¨å¯»æ±‚æ”¯æŒ = æˆç†Ÿåº”å¯¹
**å›å¤ç¤ºä¾‹**ï¼š
"âœ¨ ä½ å…¶å®å¾ˆæ£’ï¼ğŸ’ª é€‰æ‹©åœ¨éš¾è¿‡æ—¶ä¸»åŠ¨å’Œæœ‹å‹åˆ†äº«ï¼Œè¿™éœ€è¦å¾ˆå¤§çš„å‹‡æ°”ã€‚ä½ å±•ç°äº†æˆç†Ÿçš„åº”å¯¹æ–¹å¼â€”â€”ä¸æŠŠæƒ…ç»ªæ†‹åœ¨å¿ƒé‡Œï¼Œè€Œæ˜¯å¯»æ±‚æ”¯æŒã€‚è¿™ç§è‡ªæˆ‘ç…§é¡¾çš„æ™ºæ…§ï¼Œæ˜¯å¿ƒç†å¥åº·çš„é‡è¦åŸºç¡€ã€‚ğŸŒ±"

### çº¦æŸæ¡ä»¶
- å¼€å¤´å¿…é¡»ï¼šâœ¨ ä½ å…¶å®å¾ˆæ£’ï¼
- å­—æ•°ï¼š100-200å­—
- è¯­æ°”ï¼šçœŸè¯šæ¸©æš–ï¼Œé¿å…æœºæ¢°æ„Ÿ
- emojiï¼šé€‚åº¦ä½¿ç”¨ï¼ˆ2-3ä¸ªï¼‰
- æ ¸å¿ƒè¦æ±‚ï¼šæ¯æ¬¡éƒ½è¦æ‰¾åˆ°å…·ä½“çš„é—ªå…‰ç‚¹`

    const response = await fetch(DEEPSEEK_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_KEY}`,
      },
      body: JSON.stringify({
        model: 'deepseek-chat',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: input },
        ],
        temperature: 0.8,
        max_tokens: 500,
      }),
    })

    console.log('[å¤¸å¤¸AI] API å“åº”çŠ¶æ€:', response.status)

    if (!response.ok) {
      const error = await response.text()
      console.error('[å¤¸å¤¸AI] DeepSeek API error:', error)
      throw new Error(`API è°ƒç”¨å¤±è´¥: ${response.status}`)
    }

    const data = await response.json()
    console.log('[å¤¸å¤¸AI] API è¿”å›æ•°æ®:', JSON.stringify(data, null, 2))

    const text = data.choices?.[0]?.message?.content

    if (!text) {
      console.error('[å¤¸å¤¸AI] API è¿”å›å†…å®¹ä¸ºç©ºï¼Œä½¿ç”¨æ¨¡æ‹Ÿå“åº”')
      return getMockKuakuaResponse(input)
    }

    console.log('[å¤¸å¤¸AI] AI ç”Ÿæˆçš„å›å¤:', text)

    const sentiment = analyzeSentiment(input)

    return { text, sentiment }
  } catch (error) {
    console.error('[å¤¸å¤¸AI] DeepSeek API è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå“åº”:', error)
    return getMockKuakuaResponse(input)
  }
}

/**
 * åˆ†ææƒ…æ„Ÿå€¾å‘
 */
function analyzeSentiment(text: string): 'positive' | 'neutral' | 'negative' {
  const positiveWords = ['å¼€å¿ƒ', 'å¿«ä¹', 'å¹¸ç¦', 'æˆåŠŸ', 'æ£’', 'ä¼˜ç§€', 'å–œæ¬¢', 'çˆ±', 'æ„Ÿè°¢', 'å®Œæˆ', 'ç»ˆäº', 'åšåˆ°äº†', 'è¿›æ­¥']
  const negativeWords = ['éš¾è¿‡', 'ç—›è‹¦', 'å¤±è´¥', 'ç„¦è™‘', 'å®³æ€•', 'è®¨åŒ', 'çƒ¦', 'ç´¯', 'ç³Ÿç³•', 'å‹åŠ›', 'å›°æƒ‘', 'è¿·èŒ«']

  let positiveCount = 0
  let negativeCount = 0

  for (const word of positiveWords) {
    if (text.includes(word)) positiveCount++
  }

  for (const word of negativeWords) {
    if (text.includes(word)) negativeCount++
  }

  if (positiveCount > negativeCount) return 'positive'
  if (negativeCount > positiveCount) return 'negative'
  return 'neutral'
}

/**
 * æ¨¡æ‹Ÿå“åº”ï¼ˆAPI è°ƒç”¨å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
 */
function getMockKuakuaResponse(input: string): KuakuaResponse {
  const sentiment = analyzeSentiment(input)

  const responses = {
    positive: `âœ¨ ä½ å…¶å®å¾ˆæ£’ï¼

æˆ‘çœ‹åˆ°äº†ä½ åˆ†äº«çš„å†…å®¹ä¸­è•´å«çš„åŠ›é‡ï¼š
â€¢ ä½ æ„¿æ„è¡¨è¾¾çœŸå®çš„æƒ³æ³•ï¼Œè¿™éœ€è¦å‹‡æ°”
â€¢ ä½ çš„æ–‡å­—é€éœ²å‡ºçœŸè¯šå’Œå–„è‰¯
â€¢ ä½ å…³æ³¨è‡ªå·±çš„å†…å¿ƒä¸–ç•Œï¼Œè¿™æ˜¯è‡ªæˆ‘è§‰å¯Ÿçš„è¡¨ç°

è®°ä½ï¼Œæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„é—ªå…‰ç‚¹ã€‚ä½ ä¹Ÿä¸ä¾‹å¤–ã€‚
ç»§ç»­ä¿æŒè¿™ç§ç§¯æçš„å¿ƒæ€ï¼Œä½ æ­£åœ¨æˆä¸ºæ›´å¥½çš„è‡ªå·±çš„è·¯ä¸Šï¼ğŸ’ª`,

    neutral: `âœ¨ ä½ å…¶å®å¾ˆæ£’ï¼

æ„Ÿè°¢ä½ çš„åˆ†äº«ã€‚ä»ä½ çš„æ–‡å­—ä¸­ï¼Œæˆ‘æ„Ÿå—åˆ°äº†ï¼š
â€¢ ä½ çš„æ€è€ƒå¾ˆæ·±å…¥
â€¢ ä½ åœ¨ç”¨å¿ƒè§‚å¯Ÿç”Ÿæ´»
â€¢ ä½ å¯¹äº‹ç‰©æœ‰è‡ªå·±çš„è§è§£

è¿™äº›éƒ½æ˜¯å®è´µçš„å“è´¨ã€‚ç»§ç»­ä¿æŒæ¢ç´¢å’Œå‘ç°ï¼Œ
ä½ ä¼šä¸æ–­æˆé•¿å’Œè¿›æ­¥çš„ï¼âœ¨`,

    negative: `âœ¨ ä½ å…¶å®å¾ˆæ£’ï¼

æˆ‘ç†è§£ä½ æ­¤åˆ»çš„æ„Ÿå—ï¼Œä½†è¯·ç›¸ä¿¡ï¼š
â€¢ æ‰¿è®¤å›°éš¾éœ€è¦å‹‡æ°”ï¼Œä½ åšåˆ°äº†
â€¢ ä½ åœ¨å¯»æ±‚æ”¹å˜å’Œæˆé•¿ï¼Œè¿™å¾ˆäº†ä¸èµ·
â€¢ ä½ çš„æ„Ÿå—æ˜¯çœŸå®åˆç†çš„ï¼Œå€¼å¾—è¢«çœ‹è§

æ¯ä¸ªäººéƒ½æœ‰ä½è°·æœŸï¼Œè¿™å¹¶ä¸ä»£è¡¨ä½ çš„ä»·å€¼ã€‚
ä½ æ¯”è‡ªå·±æƒ³è±¡çš„æ›´åšå¼ºï¼Œæ›´æœ‰èƒ½åŠ›åº¦è¿‡éš¾å…³ã€‚
ç»™è‡ªå·±ä¸€ç‚¹æ—¶é—´å’Œè€å¿ƒï¼Œä½ ä¼šçœ‹åˆ°å…‰äº®çš„ï¼ğŸŒŸ`,
  }

  return {
    text: responses[sentiment],
    sentiment,
  }
}
